@using Domain.Money.DTOs
@using Domain.Money.Entities
@using Domain.Products.DTOs
@using Presentation.Core.Components
@using Application.Products
@using Application.Money
@using Application.CashInventory
@inject IProductService ProductService
@inject ICashService CashService
@inject ICashInventoryService InventoryService
@inject ISnackbar SnackBar

<MudDialog @bind-IsVisible="_succesfulPurchase">
    <TitleContent>
        <MudText Typo="Typo.h6">
            Su vuelto es de: @InventoryService.CostFormat(finalChange)
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudTreeView T="string">
            <MudTreeViewItem Value="@("Desglose de cambio")">
                @foreach (var item in _consumerChange)
                { 
                    <MudTreeViewItem Value="@(item.amount+" "+item.name +" "+item.price)" />
                }
            </MudTreeViewItem>
        </MudTreeView>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="TogglesuccesfulPurchase" Class="px-10">Aceptar</MudButton>
    </DialogActions>
 </MudDialog>

<Overlay IsOpen="buyPressed">
        <MudPaper Class="align-left border-none"  Elevation="0" Outlined="false" Style="max-width: 60vw; width: 60vw; height: 43vw; overflow: auto; max-height: 95vh; ">
            <MudText Align="Align.Right" Typo="Typo.h6">Costo total: @InventoryService.CostFormat(totalCost) </MudText>
            <MudTable @ref="@_table" Items="@_consumerPayment" Elevation="4" Outlined="true" Hover="true" Breakpoint="Breakpoint.Sm">
                <ToolBarContent>
                    <MudButton Color="Color.Primary" OnClick="MakePayment" Variant="Variant.Filled">Realizar pago </MudButton>
                    <MudSpacer />
                    <MudButton Variant="Variant.Filled" Color="Color.Transparent" OnClick="SendConmuteSignal" Size="Size.Medium">Cancelar</MudButton>
                </ToolBarContent> 
                <HeaderContent>
                    <MudTh>Tipo de pago</MudTh>
                    <MudTh>Valor</MudTh>
                    <MudTh>Unidades ingresadas</MudTh>
                </HeaderContent>
        
                <RowTemplate>
                        <MudTd DataLabel="Tipo de pago">@context.name</MudTd>
                        <MudTd DataLabel="Valor">@context.price</MudTd>
                        <MudTd DataLabel="Unidades ingresadas">
                            @if(context.requestedUnits < 0)
                            {
                                <MudNumericField Immediate="true" @bind-Value="context.requestedUnits" Label="Cantidad" Variant="Variant.Text"  Error="true" Min="0"/>
                            }
                            else{
                                <MudNumericField  Immediate="true" @bind-Value="context.requestedUnits" Label="Cantidad" Variant="Variant.Text" Min="0"/>
                            }
                        </MudTd>
                </RowTemplate>
        </MudTable>
        </MudPaper>
</Overlay>

@code {
    [Parameter]
    public bool buyPressed { get; set; }
    [Parameter]
    public EventCallback conMuteOverlayState { get; set; }
    [Parameter]
    public EventCallback updateStockState { get; set; }
    [CascadingParameter]
    public double totalCost { get; set; }

    private double _consumerTotalPayment { get; set; }

    private IList<CashDTO> _changeBox = new List<CashDTO>();

    private IList<CashDTO> _consumerPayment = new List<CashDTO>(){
            new CashDTO(0,1000,"Billete",0),
            new CashDTO(0,500,"Moneda",0),
            new CashDTO(0,100,"Moneda",0),
            new CashDTO(0,50,"Moneda",0),
            new CashDTO(0,25,"Moneda",0),
    };

    private MudTable<CashDTO> _table;

    private bool _succesfulPurchase = false;

    private IList<Cash> _consumerChange = new List<Cash>();

    private double finalChange = 0;

    protected override void OnInitialized()
    {
        IList<Cash> availableCash = CashService.GetAvailableCash();
        foreach (var product in availableCash)
        {
            _changeBox.Add(new CashDTO(product.amount, product.price, product.name, 0));
        }
    }  

    private async Task SendConmuteSignal()
    {
        await conMuteOverlayState.InvokeAsync();
    }

    private void MakePayment()
    {
        InventoryService.SetInventory(_consumerPayment);
        _consumerTotalPayment = InventoryService.UpdateTotalCost();
        if (_consumerTotalPayment >= totalCost)
        {
            InventoryService.SetInventory(_changeBox);
            double changeBoxValue = InventoryService.GetFullInventoryCost();
            double consumerChange = _consumerTotalPayment - totalCost;
            if (changeBoxValue >= consumerChange)
            {
                finalChange = consumerChange;
                var result = InventoryService.GetPaymentChange(consumerChange);
                GroupChange(result);
                _succesfulPurchase = true;
            }
            else
            {
                SnackBar.Add("Fallo al realizar la compra, no hay cambio suficiente", Severity.Error);
            }
        }
        else
        {
            SnackBar.Add("El monto ingresado es insuficiente, inténtelo de nuevo", Severity.Error);
        }
    }

    private void InitConsumerPayment()
    {
        _consumerPayment = new List<CashDTO>(){
            new CashDTO(0,1000,"Billete",0),
            new CashDTO(0,500,"Moneda",0),
            new CashDTO(0,100,"Moneda",0),
            new CashDTO(0,50,"Moneda",0),
            new CashDTO(0,25,"Moneda",0),
        };
    }

    private void TogglesuccesfulPurchase()
    {
        _succesfulPurchase = !_succesfulPurchase;
        private IList<Cash> _consumerChange = new List<Cash>();
        InitConsumerPayment();
        updateStockState.InvokeAsync();
    }

    private void GroupChange(IList<CashDTO> consumerChange)
    {
        var GroupedChange = 
                        from cash in consumerChange
                        group cash by cash.price;

        foreach (var cashGroup in GroupedChange)
        {
            var cash = cashGroup.FirstOrDefault();
            _consumerChange.Add(new Cash(cashGroup.Count(), cashGroup.FirstOrDefault().price, cash.name));
        }
    }
}
